import { neon } from '@neondatabase/serverless';
const connectionString = process.env.DATABASE_URL!;
export const sql = neon(connectionString);
export async function ensureUser(userId: string, email?: string) { await sql`insert into users (id, email) values (${userId}, ${email || null}) on conflict (id) do nothing`; }
export async function upsertSubscription(a:{userId:string;status:string;plan:string|null;stripeCustomerId?:string|null;stripeSubscriptionId?:string|null;currentPeriodStart?:Date|null;currentPeriodEnd?:Date|null;cancelAtPeriodEnd?:boolean|null;trialEndsAt?:Date|null;}){const{userId,status,plan,stripeCustomerId=null,stripeSubscriptionId=null,currentPeriodStart=null,currentPeriodEnd=null,cancelAtPeriodEnd=null,trialEndsAt=null}=a;await sql`insert into subscriptions (user_id,status,plan,stripe_customer_id,stripe_subscription_id,current_period_start,current_period_end,cancel_at_period_end,trial_ends_at,updated_at) values (${userId},${status},${plan},${stripeCustomerId},${stripeSubscriptionId},${currentPeriodStart},${currentPeriodEnd},${cancelAtPeriodEnd},${trialEndsAt},now()) on conflict (user_id) do update set status=excluded.status,plan=excluded.plan,stripe_customer_id=excluded.stripe_customer_id,stripe_subscription_id=excluded.stripe_subscription_id,current_period_start=excluded.current_period_start,current_period_end=excluded.current_period_end,cancel_at_period_end=excluded.cancel_at_period_end,trial_ends_at=excluded.trial_ends_at,updated_at=now();`; }
