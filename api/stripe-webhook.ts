import Stripe from 'stripe';
import type { NextApiRequest, NextApiResponse } from 'next';
import { upsertSubscription, ensureUser } from '../lib/db';
export const config = { api: { bodyParser: false } };
const stripe = new Stripe(process.env.STRIPE_SECRET!, { apiVersion: '2024-06-20' });
function buffer(req: NextApiRequest){return new Promise<Buffer>((resolve,reject)=>{const c:Buffer[]=[];req.on('data',(d)=>c.push(Buffer.isBuffer(d)?d:Buffer.from(d)));req.on('end',()=>resolve(Buffer.concat(c)));req.on('error',reject);});}
function planFromPriceId(priceId?: string | null){if(!priceId)return null as any;const m:Record<string,'core'|'daily'|'max'>={[process.env.PRICE_CORE_MONTHLY||'']:'core',[process.env.PRICE_CORE_YEARLY||'']:'core',[process.env.PRICE_DAILY_MONTHLY||'']:'daily',[process.env.PRICE_DAILY_YEARLY||'']:'daily',[process.env.PRICE_MAX_MONTHLY||'']:'max',[process.env.PRICE_MAX_YEARLY||'']:'max'};return m[priceId]||null;}
export default async function handler(req: NextApiRequest, res: NextApiResponse){ if(req.method!=='POST')return res.status(405).end(); const sig=req.headers['stripe-signature']; if(!sig)return res.status(400).send('missing signature'); const buf=await buffer(req); let event:Stripe.Event; try{event=stripe.webhooks.constructEvent(buf,sig as string,process.env.STRIPE_WEBHOOK_SECRET!);}catch(e:any){return res.status(400).send(`Webhook Error: ${e.message}`);} switch(event.type){ case 'checkout.session.completed':{const s=event.data.object as Stripe.Checkout.Session;const userId=String(s.client_reference_id||''); if(!userId)break; await ensureUser(userId,s.customer_details?.email||undefined); await upsertSubscription({userId,status:'active',plan:null,stripeCustomerId:typeof s.customer==='string'?s.customer:s.customer?.id||null,stripeSubscriptionId:typeof s.subscription==='string'?s.subscription:(s.subscription as any)?.id||null,currentPeriodStart:null,currentPeriodEnd:null}); break;} case 'customer.subscription.updated': case 'customer.subscription.created': case 'customer.subscription.deleted':{const sub=event.data.object as Stripe.Subscription;const price=sub.items?.data?.[0]?.price?.id||null;const plan=planFromPriceId(price);const userId=String(sub.metadata?.user_id||'')||''; await upsertSubscription({userId,status:sub.status,plan,stripeCustomerId:typeof sub.customer==='string'?sub.customer:sub.customer?.id||null,stripeSubscriptionId:sub.id,currentPeriodStart:sub.current_period_start?new Date(sub.current_period_start*1000):null,currentPeriodEnd:sub.current_period_end?new Date(sub.current_period_end*1000):null,cancelAtPeriodEnd:sub.cancel_at_period_end??null,trialEndsAt:sub.trial_end?new Date(sub.trial_end*1000):null}); break;} default: break;} res.status(200).json({received:true}); }
